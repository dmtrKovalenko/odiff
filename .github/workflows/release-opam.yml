name: opam release

on:
  release:
    types: [published]
  # TODO: This is for testing purposes. Delete later
  push:
    branches:
      - opam

jobs:
  opam-release:
    name: Publish to opam registry
    runs-on: ubuntu-latest
    steps:
      - name: Setup OCaml
        uses: avsm/setup-ocaml@v1
        with:
          ocaml-version: 4.11.1

      - name: Install publish utils
        run: |
          opam install opam-publish

      - name: Setup user
        run: |
          git config --global user.email "dmtr.kovalenko@outlook.com"
          git config --global user.name "dmtrKovalenko"

      - name: Setup token
        run: |
          mkdir -p  ~/.opam/plugins/opam-publish/
          echo -n ${{ secrets.OPAM_RELEASE_TOKEN }} > ~/.opam/plugins/opam-publish/odiff.token

      # Checkout the projects sources
      - name: Checkout Sources
        uses: actions/checkout@v2

      - name: Fetch Tags
        run: git fetch --prune --unshallow --tags

      - name: publish odiff-core
        run: |
          opam publish --no-browser odiff-core.opam

      - name: publish odiff-io
        run: |
          opam publish --no-browser odiff-io.opam
