name: Build
on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    strategy:
      matrix:
        include:
          - target: x86_64-linux-gnu
            os: ubuntu-latest
            artifact: "linux-x64"
          - target: aarch64-linux-gnu
            os: ubuntu-latest
            artifact: "linux-arm64"
          - target: x86_64-windows-gnu
            os: windows-latest
            artifact: "windows-x64.exe"
          - target: aarch64-windows-gnu
            os: ubuntu-latest
            artifact: "windows-arm64.exe"
          - target: aarch64-macos
            os: macos-latest
            artifact: "macos-arm64"
          - target: x86_64-macos
            os: macos-13
            artifact: "macos-x64"
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Install nasm for x86 targets (Linux)
        if: contains(matrix.target, 'x86_64') && runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Install nasm for x86 targets (macOS)
        if: contains(matrix.target, 'x86_64') && runner.os == 'macOS'
        run: |
          brew install nasm

      - name: Install nasm for x86 targets (Windows)
        if: contains(matrix.target, 'x86_64') && runner.os == 'Windows'
        run: |
          choco install -y nasm

      - name: Build for ${{ matrix.target }}
        run: |
          zig build -Dtarget=${{ matrix.target }} -Doptimize=ReleaseFast --verbose

      - name: Validate binary architecture
        shell: bash
        run: |
          # Find the binary
          if [[ -f "zig-out/bin/odiff.exe" ]]; then
            BINARY_PATH="zig-out/bin/odiff.exe"
          elif [[ -f "zig-out/bin/odiff" ]]; then
            BINARY_PATH="zig-out/bin/odiff"
          else
            echo "ERROR: No binary found"
            ls -la zig-out/bin/
            exit 1
          fi

          BINARY_INFO=$(file "$BINARY_PATH")
          echo "$BINARY_INFO"
          
          case "${{ matrix.target }}" in
            *"windows"*)
              if [[ ! "$BINARY_INFO" =~ "PE32+".*"x86-64" ]] && [[ ! "$BINARY_INFO" =~ "PE32+".*"Aarch64" ]] && [[ ! "$BINARY_INFO" =~ "COFF" ]]; then
                echo "ERROR: Expected Windows PE/COFF executable, got: $BINARY_INFO"
                exit 1
              fi
              ;;
            *"linux"*)
              if [[ ! "$BINARY_INFO" =~ "ELF".*"x86-64" ]] && [[ ! "$BINARY_INFO" =~ "ELF".*"aarch64" ]]; then
                echo "ERROR: Expected Linux ELF executable, got: $BINARY_INFO"
                exit 1
              fi
              ;;
            *"macos"*)
              if [[ ! "$BINARY_INFO" =~ "Mach-O".*"x86_64" ]] && [[ ! "$BINARY_INFO" =~ "Mach-O".*"arm64" ]]; then
                echo "ERROR: Expected macOS Mach-O executable, got: $BINARY_INFO"
                exit 1
              fi
              ;;
          esac

      - name: Test binary execution (if possible)
        shell: bash
        run: |
          case "${{ matrix.target }}" in
            "x86_64-linux-gnu")
              if [[ "${{ runner.os }}" == "Linux" ]]; then
                ./zig-out/bin/odiff --help
              fi
              ;;
            "x86_64-windows-gnu")
              if [[ "${{ runner.os }}" == "Windows" ]]; then
                ./zig-out/bin/odiff.exe --help
              fi
              ;;
            "x86_64-macos")
              if [[ "${{ runner.os }}" == "macOS" ]]; then
                ./zig-out/bin/odiff --help
              fi
              ;;
            "aarch64-macos")
              if [[ "${{ runner.os }}" == "macOS" ]] && [[ "$(uname -m)" == "arm64" ]]; then
                ./zig-out/bin/odiff --help
              fi
              ;;
          esac

      - name: Copy binary to artifact name
        run: |
          if [[ -f "zig-out/bin/odiff.exe" ]]; then
            cp "zig-out/bin/odiff.exe" "odiff-${{ matrix.artifact }}"
          else
            cp "zig-out/bin/odiff" "odiff-${{ matrix.artifact }}"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: error
          name: odiff-${{ matrix.artifact }}
          path: odiff-${{ matrix.artifact }}
          retention-days: 14

  test:
    name: Run Tests (all targets)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-linux-gnu
            os: ubuntu-latest
            run_tests: true
          - target: aarch64-linux-gnu
            os: ubuntu-24.04-arm64
            run_tests: true
          - target: x86_64-windows-gnu
            os: windows-latest
            run_tests: true
          - target: aarch64-windows-gnu
            os: windows-latest
            run_tests: false
          - target: aarch64-macos
            os: macos-latest
            run_tests: true
          - target: x86_64-macos
            os: macos-13
            run_tests: true
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Install nasm for x86 targets (Linux)
        if: contains(matrix.target, 'x86_64') && runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Install nasm for x86 targets (macOS)
        if: contains(matrix.target, 'x86_64') && runner.os == 'macOS'
        run: |
          brew install nasm

      - name: Install nasm for x86 targets (Windows)
        if: contains(matrix.target, 'x86_64') && runner.os == 'Windows'
        run: |
          choco install -y nasm

      - name: Run tests
        if: matrix.run_tests == true
        run: |
          zig build test-all --summary all

      - name: Skip (runner not available)
        if: matrix.run_tests != true
        run: echo "Skipping: no hosted runner available for ${{ matrix.target }}"

  spellcheck:
    name: Spell check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run typos
        uses: crate-ci/typos@master
        with:
          config: ./typos.toml

  publish:
    name: Publish release
    needs: [build, test]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1

      - name: Download built binaries
        uses: actions/download-artifact@v4
        with:
          pattern: odiff-*
          merge-multiple: true
          path: npm_package/raw_binaries

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          always-auth: true
          registry-url: "https://registry.npmjs.org"
          cache-dependency-path: "package-lock.json"

      - name: Publish npm package
        working-directory: npm_package
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create github release
        uses: softprops/action-gh-release@v1
        with:
          files: "npm_package/raw_binaries/*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
